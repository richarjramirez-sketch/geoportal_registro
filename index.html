<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acceso - Geoportal Miner√≠a Ilegal</title>
  
  <!-- Supabase para cargar ANPs reales -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body{
      font-family:Arial, sans-serif;
      background:#0f1115;
      margin:0;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#e0e0e0;
    }
    .box{
      background:#15181d;
      width:380px;
      padding:26px;
      border-radius:10px;
      box-shadow:0 2px 14px rgba(0,0,0,.6);
    }
    h3{
      margin:0 0 20px 0;
      color:#ffffff;
      text-align:center;
    }
    label{
      font-weight:700;
      font-size:13px;
      color:#cfd8dc;
      display:block;
      margin-top:12px;
    }
    select,
    input,
    button{
      width:100%;
      padding:11px;
      margin-top:6px;
      margin-bottom:10px;
      border-radius:8px;
      border:1px solid #2a2f36;
      background:#0f1216;
      color:#ffffff;
      box-sizing:border-box;
    }
    select{
      cursor:pointer;
    }
    select option{
      background:#0f1216;
      color:#ffffff;
    }
    select:disabled{
      opacity:0.6;
      cursor:not-allowed;
    }
    button{
      border:none;
      cursor:pointer;
      background:#2e7d32;
      color:#ffffff;
      font-weight:700;
      margin-top:16px;
    }
    button:hover{
      background:#388e3c;
    }
    button:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    .msg{
      min-height:20px;
      color:#ef5350;
      font-size:13px;
      margin-top:8px;
      margin-bottom:10px;
      text-align:center;
    }
    .msg.success{
      color:#66bb6a;
    }
    .hint{
      font-size:11px;
      color:#78909c;
      text-align:center;
      margin-top:16px;
      line-height:1.4;
    }
    .loading{
      text-align:center;
      color:#90caf9;
      font-size:13px;
      padding:8px;
    }
  </style>
</head>
<body>
  <div class="box">
    <h3>üå≤ Geoportal - Detecci√≥n de Miner√≠a Ilegal en ANP</h3>

    <label>√Årea Natural Protegida</label>
    <select id="anp" disabled>
      <option value="">‚Äî Cargando ANPs ‚Äî</option>
    </select>

    <label>Correo electr√≥nico</label>
    <input id="email" type="email" placeholder="usuario@sernanp.gob.pe" autocomplete="username" />

    <label>Contrase√±a</label>
    <input id="pass" type="password" placeholder="********" autocomplete="current-password" />

    <div id="msg" class="msg"></div>

    <button id="loginBtn" onclick="login()" disabled>Ingresar</button>
    
    <div class="hint">
      Sistema de acceso al registro de detecciones de miner√≠a ilegal.<br>
      Credenciales de prueba: rramireze@sernanp.gob.pe / Admin1234
    </div>
  </div>

  <script>
    // ==========================================
    // CONFIGURACI√ìN
    // ==========================================
    const SUPABASE_URL = "https://tewrzarmckrztcrmgfjo.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRld3J6YXJtY2tyenRjcm1nZmpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODQ3NTksImV4cCI6MjA3NzA2MDc1OX0.xeQnYEVAV_eIy7zVxFU9W2Fd0xjuF4v-tQjM2REPtCc";
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // USUARIOS AUTORIZADOS (hardcoded para prueba)
    const USERS = [
      { email: "rramireze@sernanp.gob.pe", pass: "Admin1234" },
      { email: "wanco@sernanp.gob.pe", pass: "User1234" },
      { email: "anunez@sernanp.gob.pe", pass: "User1234" }
    ];

    const REDIRECT_URL = "v31.html"; // Archivo del geoportal

    // ==========================================
    // CARGAR ANPs AL INICIAR
    // ==========================================
    async function loadANPs() {
      const anpSelect = document.getElementById("anp");
      const loginBtn = document.getElementById("loginBtn");
      const msg = document.getElementById("msg");

      try {
        const { data, error } = await supabase
          .from('v_anp_selector')
          .select('anp_cod, anp_nomb')
          .order('anp_nomb', { ascending: true });

        if (error) throw error;

        anpSelect.innerHTML = '<option value="">‚Äî Seleccione un ANP ‚Äî</option>';
        
        if (data && data.length > 0) {
          data.forEach(anp => {
            const option = document.createElement('option');
            option.value = anp.anp_cod;
            option.textContent = `${anp.anp_cod} - ${anp.anp_nomb}`;
            anpSelect.appendChild(option);
          });
          
          anpSelect.disabled = false;
          loginBtn.disabled = false;
          msg.textContent = "";
          msg.className = "msg";
        } else {
          msg.textContent = "No se encontraron ANPs disponibles.";
        }

      } catch (err) {
        console.error("Error cargando ANPs:", err);
        msg.textContent = "Error al cargar las ANPs. Intente recargar la p√°gina.";
        anpSelect.innerHTML = '<option value="">‚Äî Error al cargar ‚Äî</option>';
      }
    }

    // ==========================================
    // FUNCI√ìN DE LOGIN
    // ==========================================
    function login() {
      const anpSelect = document.getElementById("anp");
      const anpCod = anpSelect.value.trim();
      const anpNomb = anpSelect.options[anpSelect.selectedIndex]?.text || "";
      const email = document.getElementById("email").value.trim().toLowerCase();
      const pass = document.getElementById("pass").value;
      const msg = document.getElementById("msg");

      // Limpiar mensaje previo
      msg.textContent = "";
      msg.className = "msg";

      // Validaciones
      if (!anpCod) {
        msg.textContent = "‚ö†Ô∏è Seleccione un ANP.";
        return;
      }
      if (!email) {
        msg.textContent = "‚ö†Ô∏è Ingrese su correo electr√≥nico.";
        return;
      }
      if (!pass) {
        msg.textContent = "‚ö†Ô∏è Ingrese su contrase√±a.";
        return;
      }

      // Verificar credenciales
      const userValid = USERS.find(u => 
        u.email.toLowerCase() === email && u.pass === pass
      );

      if (!userValid) {
        msg.textContent = "‚ùå Correo o contrase√±a incorrectos.";
        return;
      }

      // Guardar datos de sesi√≥n en localStorage
      const sessionData = {
        anp_cod: anpCod,
        anp_nomb: anpNomb,
        user_email: email,
        login_time: new Date().toISOString()
      };

      localStorage.setItem("anp_session", JSON.stringify(sessionData));

      // Mensaje de √©xito y redirecci√≥n
      msg.textContent = "‚úÖ Acceso autorizado. Redirigiendo...";
      msg.className = "msg success";

      setTimeout(() => {
        window.location.href = REDIRECT_URL;
      }, 800);
    }

    // ==========================================
    // PERMITIR LOGIN CON ENTER
    // ==========================================
    document.getElementById("email").addEventListener("keypress", (e) => {
      if (e.key === "Enter") document.getElementById("pass").focus();
    });

    document.getElementById("pass").addEventListener("keypress", (e) => {
      if (e.key === "Enter") login();
    });

    // ==========================================
    // INICIALIZAR
    // ==========================================
    window.addEventListener('DOMContentLoaded', () => {
      loadANPs();
    });
  </script>
</body>
</html>