<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Geoportal — Operativos (Interdicción) en ANP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Proj4js (WGS84 <-> UTM) para mostrar coordenadas UTM en pantalla -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.2/proj4.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; }
    header { padding:12px 16px; background:#020617; border-bottom:1px solid #1e293b; }
    main { display:grid; grid-template-columns: 420px 1fr; height:calc(100vh - 50px); }
    aside { padding:14px; background:#020617; overflow:auto; }
    #map { height:100%; }
    h3 { margin:12px 0 6px; font-size:14px; color:#93c5fd; }
    label { font-size:12px; display:block; margin-top:8px; color:#cbd5f5; }
    input, select, textarea {
      width:100%; padding:8px; border-radius:6px;
      border:1px solid #334155; background:#020617; color:#e5e7eb;
    }
    input[readonly]{ background:#0b1220; cursor:not-allowed; color:#dbeafe; }
    input:disabled, textarea:disabled, select:disabled { opacity:0.75; cursor:not-allowed; }
    textarea { resize:vertical; }
    .row2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    button {
      margin-top:10px; padding:8px; width:100%;
      background:#2563eb; border:none; border-radius:6px;
      color:white; font-weight:bold; cursor:pointer;
    }
    button.secondary { background:#0ea5e9; }
    button.tertiary { background:#475569; }
    button.ghost { background:#475569; }
    button.mini { background:#dc2626; padding:4px 8px; width:auto; margin-top:4px; font-size:11px; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    .msg { margin-top:10px; font-size:12px; padding:8px; border-radius:6px; }
    .ok { background:#064e3b; }
    .err { background:#7f1d1d; }
    .pill {
      display:inline-block; padding:4px 8px; border-radius:999px;
      background:#111827; border:1px solid #334155; font-size:12px;
      color:#e5e7eb; margin-top:8px;
    }
    .hint { font-size:11px; color:#94a3b8; margin-top:4px; font-style:italic; }
    .item { background:#111827; padding:8px; border-radius:6px; margin-top:8px; border:1px solid #334155; }
    .list { margin-top:8px; }
    .sep { margin:16px 0; border-top:1px solid #1e293b; }

    .latlon-hidden{display:none;}

    /* === Etiquetas (labels) de Puestos SERNANP: solo texto, sin caja === */
    .leaflet-tooltip.puesto-label{
      background: transparent;
      border: none;
      box-shadow: none;
      color: #ffffff;
      font-size: 11px;
      font-weight: bold;
      text-shadow: 0 0 3px #000;
      padding: 0;
    }

  </style>
</head>
<body>
<header><b>Geoportal — Operativos (Interdicción) en ANP</b></header>

<main>
  <aside>
    <h3>1) Seleccionar ANP</h3>
    <label>Área Natural Protegida</label>
    <select id="anpSelect">
      <option value="">— Cargando ANP —</option>
    </select>
    <div class="hint" id="anpNombreBox"></div>

    <h3>2) Operativo – Evento (incluye instituciones)</h3>
    <label>opera_id</label>
    <input id="operaId" readonly>

    <label>usuario_creacion</label>
    <input id="usuarioCreacion" placeholder="Ej: richar.ramirez">

    <div class="row2">
      <div>
        <label>fecha_inicio_opera</label>
        <input type="date" id="fechaInicioOpera">
      </div>
      <div>
        <label>fecha_fin_opera</label>
        <input type="date" id="fechaFinOpera">
      </div>
    </div>

    <label>objetivo</label>
    <textarea id="objetivoOpera" placeholder="Objetivo del operativo"></textarea>

    <label>resumen</label>
    <textarea id="resumenOpera" placeholder="Resumen breve (opcional)"></textarea>

    <!-- Tipo de operativo: se asume interdicción (se guarda como INTERDICCION) -->
    <input id="tipoOpera" type="hidden" value="INTERDICCION">

    <label>dete_id asociado (opcional)</label>
    <input id="deteIdAsociado" placeholder="Ej: PN08_DET_2025_012">

    <h4>Instituciones participantes</h4>
    <div class="row3">
      <div>
        <label>institución</label>
        <select id="instSelect">
          <option value="">— Cargando instituciones —</option>
        </select>
      </div>
      <div>
        <label>cantidad</label>
        <input id="instCantidad" inputmode="numeric" placeholder="Ej: 5">
      </div>
      <div>
        <label>rol</label>
        <input id="instRol" placeholder="Ej: liderazgo, seguridad">
      </div>
    </div>
    <button id="addInstBtn" class="ghost">Agregar institución</button>

    <div id="instList" class="list"></div>

    <button id="saveOperaBtn">Guardar operativo</button>

    <h3>3) Ubicación</h3>

    <label>Ubicación activa (UTM)</label>
    <div class="row3">
      <div>
        <label>zona</label>
        <input id="utmZona" placeholder="Ej: 19S">
      </div>
      <div>
        <label>este (m)</label>
        <input id="utmE" inputmode="decimal">
      </div>
      <div>
        <label>norte (m)</label>
        <input id="utmN" inputmode="decimal">
      </div>
    </div>
    <div class="hint">Tip: puedes hacer clic en el mapa para capturar la ubicación y luego ajustar los valores UTM.</div>

    <button id="saveUbicBtn">Guardar ubicación</button>
    <button id="newUbicBtn" class="ghost">Nueva ubicación</button>

    <div class="sep"></div>

    <h3>4) Componente interdictado</h3>

    <label>Componente interdictado</label>
    <div class="row3">
      <div>
        <label>componente</label>
        <select id="compSelect">
          <option value="">— Cargando componentes —</option>
        </select>
      </div>
      <div>
        <label>cantidad</label>
        <input id="compCantidad" inputmode="numeric" placeholder="Ej: 3">
      </div>
      <div>
        <label>evidencia_url (opcional)</label>
        <input id="compEvidencia" placeholder="Link (Drive, acta, etc.)">
      </div>
    </div>
    <label>descripción (opcional)</label>
    <textarea id="compDesc" placeholder="Detalle del componente interdictado"></textarea>
    <button id="addCompBtn" class="ghost">Agregar componentes</button>

    <div id="compList" class="list"></div>

    <button id="finalizeUbicBtn" class="ghost">Finalizar ubicación</button>
    <button id="closeEventBtn" class="tertiary">Cerrar evento</button>

    <div id="msg" class="msg"></div>
  </aside>

  <section id="mapWrap">
    <div id="map"></div>
  </section>
</main>

<script>
/* ================== SUPABASE ================== */
const SUPABASE_URL = "https://tewrzarmckrztcrmgfjo.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRld3J6YXJtY2tyenRjcm1nZmpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODQ3NTksImV4cCI6MjA3NzA2MDc1OX0.xeQnYEVAV_eIy7zVxFU9W2Fd0xjuF4v-tQjM2REPtCc";
var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ================== UTIL ================== */
const $ = (id) => document.getElementById(id);
const msgBox = $("msg");
function msg(text, isErr=false){
  msgBox.textContent = text || "";
  msgBox.className = "msg" + (isErr ? " err" : "");
  if(text) setTimeout(()=>{ msgBox.textContent=""; }, 5000);
}
function numOrNull(v){
  if(v===null || v===undefined) return null;
  const s = String(v).trim();
  if(!s) return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}

/* ================== MAPA ================== */
const map = L.map('map', { boxZoom:true, maxZoom: 17 });

// Basemap satelital (igual que el geoportal de Detección)
L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { maxZoom: 17 }
).addTo(map);

// Zoom inicial al Perú (aprox) + borde (si carga)
const peruBounds = L.latLngBounds(L.latLng(-18.35, -81.35), L.latLng(-0.03, -68.65));
map.fitBounds(peruBounds, { padding: [10,10] });


// ✅ Ajuste para iframes: al activar la pestaña "Operativos" desde el contenedor,
// Leaflet necesita recalcular el tamaño (invalidateSize) y re-aplicar el encuadre inicial al Perú.
let __opInitRefitDone = false;
window.addEventListener('message', (ev) => {
  const d = ev.data || {};
  if (d.type === 'activate' && d.view === 'op') {
    // Recalcular tamaño del mapa cuando el iframe pasa de oculto a visible
    setTimeout(() => {
      try { map.invalidateSize(); } catch(e) {}
      // Volver a encuadrar Perú para garantizar el zoom inicial correcto
      try { map.fitBounds(peruBounds, { padding: [10,10] }); } catch(e) {}
      // Si prefieres aplicarlo solo 1 vez, descomenta:
      // if (!__opInitRefitDone) { __opInitRefitDone = true; map.fitBounds(peruBounds, { padding: [10,10] }); }
    }, 80);
  }
});


/* ================== CAPAS ADICIONALES (Departamentos / Puestos SERNANP) ================== */
let departamentosLayer = L.geoJSON(null, {
  interactive: false, // ✅ evita que intercepte el clic del mapa
  style: { color:"#22c55e", weight:1.5, fillColor:"#22c55e", fillOpacity:0.08 }
}).addTo(map);

let puestosSernanpLayer = L.layerGroup().addTo(map);

async function loadDepartamentos(){
  const { data, error } = await supabase
    .from("departamentos")
    .select("geom, fuente, departamen, coddep, capital");

  if (error) { msg("Error cargando capa Departamentos: " + error.message, true); return; }

  departamentosLayer.clearLayers();
  (data || []).forEach(r => {
    if (!r?.geom) return;
    const feat = {
      type: "Feature",
      geometry: r.geom,
      properties: {
        fuente: r.fuente,
        departamen: r.departamen,
        coddep: r.coddep,
        capital: r.capital
      }
    };
    departamentosLayer.addData(feat);
  });
}

async function loadPuestosSernanp(anpCod){
  puestosSernanpLayer.clearLayers();

  if(!anpCod) return;

  const { data, error } = await supabase
    .from("puestos_sernanp")
    .select("geom, nomb_infra, tipo_infra, anp_cod, infra_cod, obse_infra, acce_infra")
    .eq("anp_cod", anpCod);

  if (error) { msg("Error cargando capa Puestos SERNANP: " + error.message, true); return; }

  (data || []).forEach(r => {
    const g = r?.geom;
    if (!g || !g.coordinates) return;
    const lng = g.coordinates[0];
    const lat = g.coordinates[1];

    const m = L.circleMarker([lat, lng], {
      radius: 6,
      color: "#f97316",
      weight: 2,
      fillOpacity: 0.8
    });

    // ✅ Etiqueta permanente (solo texto) con el nombre del puesto
    if (r.nomb_infra) {
      m.bindTooltip(r.nomb_infra, {
        permanent: true,
        direction: 'top',
        offset: [0, -8],
        className: 'puesto-label'
      });
    }

    const html =
      `<b>${r.nomb_infra ?? 'Puesto'}</b><br>` +
      `<b>Tipo:</b> ${r.tipo_infra ?? '-'}<br>` +
      `<b>ANP:</b> ${r.anp_cod ?? '-'}<br>` +
      `<b>Código:</b> ${r.infra_cod ?? '-'}<br>` +
      (r.acce_infra ? `<b>Acceso:</b> ${r.acce_infra}<br>` : '') +
      (r.obse_infra ? `<b>Obs.:</b> ${r.obse_infra}` : '');

    m.bindPopup(html);
    puestosSernanpLayer.addLayer(m);
  });
}


/* ================== UTM <-> WGS84 (PROJ4) ================== */
function parseZona(z){
  const s = String(z||"").trim().toUpperCase();
  const m = s.match(/^(\d{1,2})([NS])$/);
  if(!m) return null;
  const zone = parseInt(m[1],10);
  const hemi = m[2];
  if(zone<1 || zone>60) return null;
  return { zone, hemi };
}
function utmProjString(zonaStr){
  const z = parseZona(zonaStr);
  if(!z) return null;
  const south = (z.hemi === "S") ? " +south" : "";
  return `+proj=utm +zone=${z.zone}${south} +datum=WGS84 +units=m +no_defs`;
}
function utmToLonLat(zonaStr, e, n){
  const projUtm = utmProjString(zonaStr);
  if(!projUtm) return null;
  try{
    const res = proj4(projUtm, "EPSG:4326", [e, n]);
    return { lon: res[0], lat: res[1] };
  }catch(err){
    return null;
  }
}
function lonLatToUtm(zonaStr, lon, lat){
  const projUtm = utmProjString(zonaStr);
  if(!projUtm) return null;
  try{
    const res = proj4("EPSG:4326", projUtm, [lon, lat]);
    return { e: res[0], n: res[1] };
  }catch(err){
    return null;
  }
}
function autoZonaUtmFromLonLat(lon, lat){
  const zone = Math.floor((lon + 180) / 6) + 1; // 1..60
  const hemi = (lat >= 0) ? "N" : "S";
  return `${zone}${hemi}`;
}

/* ================== ELEMENTOS UI ================== */
const anpSelect = $("anpSelect");
const anpNombreBox = $("anpNombreBox");
const operaId = $("operaId");
const usuarioCreacion = $("usuarioCreacion");
const fechaInicioOpera = $("fechaInicioOpera");
const fechaFinOpera = $("fechaFinOpera");
const objetivoOpera = $("objetivoOpera");
const resumenOpera = $("resumenOpera");
const tipoOpera = $("tipoOpera");
const deteIdAsociado = $("deteIdAsociado");

const instSelect = $("instSelect");
const instCantidad = $("instCantidad");
const instRol = $("instRol");
const instList = $("instList");

const utmZona = $("utmZona");
const utmE = $("utmE");
const utmN = $("utmN");

const compSelect = $("compSelect");
const compCantidad = $("compCantidad");
const compDesc = $("compDesc");
const compEvidencia = $("compEvidencia");
const compList = $("compList");

let anpLayer = null;
let marker = null;

/* ✅ Capa donde se dibujan TODAS las ubicaciones del operativo (visibles en el mapa) */
const ubicacionesLayer = L.layerGroup().addTo(map);

/* ✅ Candado para evitar múltiples clics en "Guardar ubicación" */
let ubicacionEnProceso = false;
let currentOperaId = null;
let currentUbicId = null;

let instCache = [];   // lista local de instituciones agregadas
let compCache = [];   // lista local de componentes agregados para la ubicación activa

/* ================== CARGA ANP (selector + polígono) ================== */
async function cargarANP(){
  try{
    const { data, error } = await supabase
      .from("v_anp_selector")
      .select("anp_cod, anp_nomb, extent_geojson")
      .order("anp_nomb", { ascending:true });

    if(error) throw error;

    anpSelect.innerHTML = '<option value="">— Selecciona —</option>' + (data||[]).map(r =>
      `<option value="${r.anp_cod}" data-name="${(r.anp_nomb||"").replace(/"/g,"&quot;")}">${r.anp_nomb}</option>`
    ).join("");
    return;
  }catch(e){
    let data = null, error = null;

    ({ data, error } = await supabase
      .from("anp_mineria_ilegal")
      .select("anp_cod, anp_nombre")
      .order("anp_nombre", { ascending:true })
    );

    if(error){
      ({ data, error } = await supabase
        .from("anp_mineria_ilegal")
        .select("anp_cod")
        .order("anp_cod", { ascending:true })
      );
    }

    if(error){
      anpSelect.innerHTML = '<option value="">— Error cargando ANP —</option>';
      msg("Error cargando ANP: " + error.message, true);
      return;
    }

    const seen = new Set();
    const rows = (data||[]).filter(r=>{
      const k = r.anp_cod;
      if(!k || seen.has(k)) return false;
      seen.add(k);
      return true;
    });

    anpSelect.innerHTML = '<option value="">— Selecciona —</option>' + rows.map(r => {
      const name = (r.anp_nombre ? `${r.anp_nombre} (${r.anp_cod})` : r.anp_cod);
      return `<option value="${r.anp_cod}" data-name="${(r.anp_nombre||"").replace(/"/g,"&quot;")}">${name}</option>`;
    }).join("");
  }
}

async function mostrarPoligonoANP(anpCod){
  if(anpLayer){ map.removeLayer(anpLayer); anpLayer = null; }
  if(!anpCod) return;

  const { data, error } = await supabase
    .from("anp_mineria_ilegal")
    .select("geom")
    .eq("anp_cod", anpCod)
    .maybeSingle();

  if(error){
    msg("No se pudo cargar polígono ANP: " + error.message, true);
    return;
  }
  if(!data || !data.geom) return;

  anpLayer = L.geoJSON(data.geom, { style:{ color:"#00ffff", weight:2, fill:false } }).addTo(map);
  map.fitBounds(anpLayer.getBounds(), {
    paddingTopLeft: [-10, -10],
    paddingBottomRight: [-10, -10],
    maxZoom: 15
  });
}

/* ================== AUTOGENERAR opera_id ================== */
async function genOperaId(anpCod){
  const year = new Date().getFullYear();
  const prefix = `${anpCod}_OPERA_${year}_`;

  const { data, error } = await supabase
    .from("operativo_evento")
    .select("opera_id")
    .eq("anp_cod", anpCod)
    .like("opera_id", `${prefix}%`);

  if(error){
    msg("No se pudo generar opera_id: " + error.message, true);
    return;
  }

  let max = 0;
  const re = new RegExp(`^${anpCod}_OPERA_${year}_(\\d{3})$`);
  (data||[]).forEach(r=>{
    const m = String(r.opera_id || "").match(re);
    if(m) max = Math.max(max, parseInt(m[1],10));
  });

  operaId.value = `${anpCod}_OPERA_${year}_${String(max+1).padStart(3,"0")}`;
}

/* ================== CARGA CATÁLOGOS ================== */
async function cargarInstituciones(){
  const { data, error } = await supabase
    .from("dom_institucion")
    .select("inst_cod, inst_desc")
    .order("inst_desc", { ascending:true });

  if(error){
    instSelect.innerHTML = '<option value="">— Error —</option>';
    msg("Error cargando instituciones: " + error.message, true);
    return;
  }
  instSelect.innerHTML = '<option value="">— Selecciona —</option>' + (data||[]).map(r =>
    `<option value="${r.inst_cod}">${r.inst_desc} (${r.inst_cod})</option>`
  ).join("");
}

async function cargarComponentes(){
  const { data, error } = await supabase
    .from("dom_componente_interdiccion")
    .select("comp_int_cod, comp_int_desc")
    .order("comp_int_desc", { ascending:true });

  if(error){
    compSelect.innerHTML = '<option value="">— Error —</option>';
    msg("Error cargando componentes: " + error.message, true);
    return;
  }
  compSelect.innerHTML = '<option value="">— Selecciona —</option>' + (data||[]).map(r =>
    `<option value="${r.comp_int_cod}">${r.comp_int_desc} (${r.comp_int_cod})</option>`
  ).join("");
}

/* ================== UI LISTAS ================== */
function renderInst(){
  if(!instCache.length){ instList.innerHTML = "<i>Sin instituciones agregadas</i>"; return; }
  instList.innerHTML = instCache.map((r, i)=>`
    <div class="item">
      <div><b>${r.inst_cod}</b> · ${r.cantidad_personal ?? ""} ${r.rol ? "· " + r.rol : ""}</div>
      <button class="mini" data-i="${i}" data-act="del">Quitar</button>
    </div>
  `).join("");
  instList.querySelectorAll("button.mini").forEach(btn=>{
    btn.onclick = ()=>{
      const i = parseInt(btn.dataset.i,10);
      instCache.splice(i,1);
      renderInst();
    };
  });
}

function renderComp(){
  if(!currentUbicId){
    compList.innerHTML = "<i>Primero guarda una ubicación</i>";
    return;
  }
  if(!compCache.length){ compList.innerHTML = "<i>Sin componentes agregados</i>"; return; }
  compList.innerHTML = compCache.map((r, i)=>`
    <div class="item">
      <div><b>${r.comp_int_cod}</b> · ${r.cantidad ?? ""} ${r.descripcion ? "· " + r.descripcion : ""}</div>
      <button class="mini" data-i="${i}" data-act="del">Quitar</button>
    </div>
  `).join("");
  compList.querySelectorAll("button.mini").forEach(btn=>{
    btn.onclick = ()=>{
      const i = parseInt(btn.dataset.i,10);
      compCache.splice(i,1);
      renderComp();
    };
  });
}

/* ================== EVENTOS UI ================== */
anpSelect.addEventListener("change", async ()=>{
  const anpCod = anpSelect.value || "";
  const opt = anpSelect.options[anpSelect.selectedIndex];
  const anpName = (opt && opt.dataset && opt.dataset.name) ? opt.dataset.name : "";
  anpNombreBox.textContent = anpName || "";

  currentOperaId = null;
  currentUbicId = null;
  instCache = [];
  compCache = [];
  $("saveOperaBtn").disabled = false;
  renderInst(); renderComp();
  ubicacionesLayer.clearLayers();

  if(!anpCod){
    operaId.value = "";
    if(anpLayer){ map.removeLayer(anpLayer); anpLayer=null; }
    map.fitBounds(peruBounds, { padding:[10,10] });
    // Limpiar puestos SERNANP al deseleccionar ANP
    puestosSernanpLayer.clearLayers();
    return;
  }

  await mostrarPoligonoANP(anpCod);
  // ✅ Puestos SERNANP (con etiquetas) para el ANP seleccionado
  await loadPuestosSernanp(anpCod);
  await genOperaId(anpCod);
});

$("addInstBtn").onclick = ()=>{
  if(!operaId.value){ msg("Primero selecciona ANP y genera opera_id.", true); return; }
  const inst = instSelect.value;
  if(!inst){ msg("Selecciona una institución.", true); return; }
  const cant = numOrNull(instCantidad.value);
  const rol = (instRol.value||"").trim();

  if(instCache.some(x=>x.inst_cod===inst)){ msg("Esa institución ya fue agregada.", true); return; }

  instCache.push({ inst_cod: inst, cantidad_personal: cant, rol });
  instCantidad.value = ""; instRol.value = "";
  renderInst();
};

$("saveOperaBtn").onclick = async ()=>{
  const anpCod = anpSelect.value || "";
  if(!anpCod){ msg("Selecciona un ANP.", true); return; }
  if(!operaId.value){ msg("No se generó opera_id.", true); return; }

  const fi = fechaInicioOpera.value || null;
  const ff = fechaFinOpera.value || null;
  if(fi && ff && ff < fi){ msg("fecha_fin_opera no puede ser menor que fecha_inicio_opera.", true); return; }

  function bumpOperaId(id){
    const m = String(id||"").match(/^(.*?_OPERA_\d{4}_)(\d{3})$/);
    if(!m) return null;
    const next = parseInt(m[2],10) + 1;
    return m[1] + String(next).padStart(3,"0");
  }

  async function tryInsertOperativoWithRetry(){
    const basePayload = {
      anp_cod: anpCod,
      fecha_inicio_opera: fi,
      fecha_fin_opera: ff,
      tipo_opera: tipoOpera.value || null,
      dete_id: (deteIdAsociado.value||"").trim() || null,
      objetivo: (objetivoOpera.value||"").trim() || null,
      resumen: (resumenOpera.value||"").trim() || null,
      usuario_creacion: (usuarioCreacion.value||"").trim() || null
    };

    for(let attempt=0; attempt<15; attempt++){
      const payload = { ...basePayload, opera_id: operaId.value };

      const { error } = await supabase.from("operativo_evento").insert(payload);
      if(!error) return { ok:true, payload };

      const isDup = (error.code === "23505") || (String(error.message||"").includes("duplicate key"));
      if(isDup){
        const nextId = bumpOperaId(operaId.value);
        if(!nextId) return { ok:false, error };
        operaId.value = nextId;
        continue;
      }

      return { ok:false, error };
    }

    return { ok:false, error: { message: "No se pudo asignar un opera_id libre (reintentos agotados)." } };
  }

  const result = await tryInsertOperativoWithRetry();
  if(!result.ok){
    msg("Error operativo: " + result.error.message, true);
    return;
  }

  currentOperaId = result.payload.opera_id;

  if(instCache.length){
    const rows = instCache.map(r=>({ opera_id: currentOperaId, ...r }));
    const { error: e2 } = await supabase.from("operativo_evento_institucion").insert(rows);
    if(e2){
      msg("Operativo guardado, pero error instituciones: " + e2.message, true);
      return;
    }
  }

  await cargarUbicacionesOperativo();
  $("saveOperaBtn").disabled = true;
  msg("Operativo guardado correctamente.");
};

function setMarker(lat, lon){
  if(marker){ map.removeLayer(marker); marker=null; }
  marker = L.marker([lat, lon]).addTo(map);
}

/* ================== ✅ DIBUJAR UBICACIONES DEL OPERATIVO (visibles en el mapa) ================== */

/* ================== POPUP: DETALLE DE UBICACIÓN (visible incluso si el evento se cierra) ================== */
function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}

async function buildUbicPopupHtml(operaUbicId, lat, lon){
  const zonaAuto = autoZonaUtmFromLonLat(lon, lat);
  const utm = lonLatToUtm(zonaAuto, lon, lat);
  const utmTxt = utm ? `${zonaAuto} | E ${utm.e.toFixed(2)} | N ${utm.n.toFixed(2)}` : `${zonaAuto}`;

  // Traer componentes interdictados de la ubicación
  const { data: comps, error: e1 } = await supabase
    .from("operativo_resultado")
    .select("comp_int_cod, cantidad, descripcion, evidencia_url")
    .eq("opera_ubic_id", operaUbicId)
    ;

  let compHtml = "";
  if (e1) {
    compHtml = `<i>Error cargando componentes: ${escapeHtml(e1.message)}</i>`;
  } else if (!comps || comps.length === 0) {
    compHtml = `<i>Sin componentes registrados</i>`;
  } else {
    // Intentar traducir códigos a descripciones (catálogo)
    const cods = [...new Set(comps.map(x=>x.comp_int_cod).filter(Boolean))];
    let dict = {};
    if (cods.length){
      const { data: cat, error: e2 } = await supabase
        .from("dom_componente_interdiccion")
        .select("comp_int_cod, comp_int_desc")
        .in("comp_int_cod", cods);
      if (!e2 && cat){
        cat.forEach(r=>{ dict[r.comp_int_cod] = r.comp_int_desc; });
      }
    }

    compHtml = `<b>Componentes interdictados:</b><br>` + comps.map(r=>{
      const desc = dict[r.comp_int_cod] ? `${dict[r.comp_int_cod]} (${r.comp_int_cod})` : (r.comp_int_cod || "-");
      const cant = (r.cantidad ?? "-");
      const det = r.descripcion ? ` — ${escapeHtml(r.descripcion)}` : "";
      const evid = r.evidencia_url ? ` <br><span style="font-size:11px;color:#94a3b8;">Evidencia:</span> <a href="${escapeHtml(r.evidencia_url)}" target="_blank" rel="noopener noreferrer">abrir</a>` : "";
      return `• ${escapeHtml(desc)} (N°: ${escapeHtml(cant)})${det}${evid}`;
    }).join("<br>");
  }

  return `
    <b>Ubicación:</b> ${escapeHtml(operaUbicId)}<br>
    <b>Lat/Lon:</b> ${Number(lat).toFixed(6)} / ${Number(lon).toFixed(6)}<br>
    <b>UTM (auto):</b> ${escapeHtml(utmTxt)}<hr style="border:0;border-top:1px solid #334155;">
    ${compHtml}
  `;
}
async function cargarUbicacionesOperativo(){
  ubicacionesLayer.clearLayers();
  if(!currentOperaId) return;

  const { data, error } = await supabase
    .from("operativo_ubicacion")
    .select("opera_ubic_id, geom, latitud, longitud")
    .eq("opera_id", currentOperaId)
    .order("opera_ubic_id", { ascending: true });

  if(error){
    msg("Error cargando ubicaciones del operativo: " + error.message, true);
    return;
  }

  (data || []).forEach(u=>{
    const g = u.geom;
    // Acepta GeoJSON (type/coordinates) o latitud/longitud si existieran
    let lon = null, lat = null;
    if(g && g.coordinates && Array.isArray(g.coordinates)){
      lon = g.coordinates[0];
      lat = g.coordinates[1];
    } else if (typeof u.longitud === "number" && typeof u.latitud === "number"){
      lon = u.longitud; lat = u.latitud;
    }
    if(lon===null || lat===null) return;

    const m = L.circleMarker([lat, lon], {
      radius: 7,
      color: "#38bdf8",
      weight: 2,
      fillOpacity: 0.65
    });

    m.on("click", async (ev)=>{
      // ✅ Evita que el click del punto dispare también el click del mapa
      if(ev && ev.originalEvent) L.DomEvent.stopPropagation(ev.originalEvent);

      const html = await buildUbicPopupHtml(u.opera_ubic_id, lat, lon);
      m.bindPopup(html, { maxWidth: 420 }).openPopup();
    });

    ubicacionesLayer.addLayer(m);
  });
}

/* Click en mapa -> actualiza UTM y marcador (AUTO ZONA + AUTO COORDENADAS) */
map.on("click", (e)=>{
  // ✅ Si ya existe una ubicación guardada (activa) o se está guardando, no permitir marcar otra
  if (currentUbicId || ubicacionEnProceso) {
    msg("⚠️ Finaliza la ubicación actual antes de marcar otra.", true);
    return;
  }
  let z = (utmZona.value||"").trim();

  if(!parseZona(z)){
    z = autoZonaUtmFromLonLat(e.latlng.lng, e.latlng.lat);
    utmZona.value = z;
  }

  setMarker(e.latlng.lat, e.latlng.lng);

  const utm = lonLatToUtm(z, e.latlng.lng, e.latlng.lat);
  if(!utm){
    msg("No se pudo calcular UTM para la zona " + z + ".", true);
    return;
  }
  utmE.value = utm.e.toFixed(2);
  utmN.value = utm.n.toFixed(2);
});

/* Editar UTM -> mueve marcador */
function updateFromUtm(){
  const z = (utmZona.value||"").trim();
  const e = numOrNull(utmE.value);
  const n = numOrNull(utmN.value);
  if(!parseZona(z) || e===null || n===null) return;
  const ll = utmToLonLat(z, e, n);
  if(!ll) return;
  setMarker(ll.lat, ll.lon);
}
utmZona.addEventListener("input", updateFromUtm);
utmE.addEventListener("input", updateFromUtm);
utmN.addEventListener("input", updateFromUtm);

$("saveUbicBtn").onclick = async ()=>{
  if(!currentOperaId){
    msg("Primero guarda el operativo (Paso 2).", true);
    return;
  }
  // ✅ Evita múltiples clics y duplicados
  if (ubicacionEnProceso) {
    msg("⚠️ Ya se está guardando esta ubicación.", true);
    return;
  }
  if (currentUbicId) {
    msg("⚠️ Ya tienes una ubicación activa. Finalízala para registrar otra.", true);
    return;
  }

  ubicacionEnProceso = true;
  $("saveUbicBtn").disabled = true;

  const z = (utmZona.value||"").trim();
  const e = numOrNull(utmE.value);
  const n = numOrNull(utmN.value);
  if(!parseZona(z) || e===null || n===null){
    msg("Completa zona/este/norte en UTM.", true);
    return;
  }
  const ll = utmToLonLat(z, e, n);
  if(!ll){ msg("No se pudo convertir UTM a WGS84.", true); return; }

  const geom = { type:"Point", coordinates:[ll.lon, ll.lat] };
  const payload = {
    opera_id: currentOperaId,
    geom,
    longitud: ll.lon,
    latitud: ll.lat
  };

  const { data, error } = await supabase
    .from("operativo_ubicacion")
    .insert(payload)
    .select("opera_ubic_id")
    .single();

  if(error){
    ubicacionEnProceso = false;
    $("saveUbicBtn").disabled = false;
    msg("Error ubicación: " + error.message, true);
    return;
  }

  currentUbicId = data.opera_ubic_id;
  ubicacionEnProceso = false;
  // Mantener deshabilitado Guardar ubicación hasta finalizar
  $("saveUbicBtn").disabled = true;
  compCache = [];
  renderComp();
  await cargarUbicacionesOperativo();
  msg("Ubicación guardada. Ahora agrega componentes interdictados.");
};

/* Nueva ubicación (debajo de Guardar ubicación) */
$("newUbicBtn").onclick = ()=>{
  currentUbicId = null;
  ubicacionEnProceso = false;
  $("saveUbicBtn").disabled = false;
  compCache = [];
  renderComp();
  utmZona.value = "";
  utmE.value = "";
  utmN.value = "";
  if(marker){ map.removeLayer(marker); marker=null; }
  msg("Lista para registrar una nueva ubicación.");
};

/* Agregar componentes */
$("addCompBtn").onclick = async ()=>{
  if(!currentUbicId){
    msg("Primero guarda una ubicación.", true);
    return;
  }
  const comp = compSelect.value;
  if(!comp){ msg("Selecciona un componente.", true); return; }
  const cant = numOrNull(compCantidad.value);
  const desc = (compDesc.value||"").trim() || null;
  const evid = (compEvidencia.value||"").trim() || null;

  const payload = {
    opera_ubic_id: currentUbicId,
    comp_int_cod: comp,
    cantidad: cant,
    descripcion: desc,
    evidencia_url: evid
  };

  const { error } = await supabase.from("operativo_resultado").insert(payload);
  if(error){ msg("Error componente: " + error.message, true); return; }

  compCache.push(payload);
  compCantidad.value = "";
  compDesc.value = "";
  compEvidencia.value = "";
  renderComp();
  msg("Componente agregado.");
};

/* Finalizar ubicación */
$("finalizeUbicBtn").onclick = ()=>{
  currentUbicId = null;
  ubicacionEnProceso = false;
  $("saveUbicBtn").disabled = false;
  compCache = [];
  renderComp();
  msg("Ubicación finalizada. Puedes registrar otra ubicación.");
};

/* Cerrar evento */
$("closeEventBtn").onclick = async ()=>{
  const anpCod = anpSelect.value || "";
  ubicacionEnProceso = false;
  $("saveUbicBtn").disabled = false;

  currentUbicId = null;
  compCache = [];
  renderComp();

  instCache = [];
  renderInst();

  currentOperaId = null;

  fechaInicioOpera.value = "";
  fechaFinOpera.value = "";
  objetivoOpera.value = "";
  resumenOpera.value = "";
  deteIdAsociado.value = "";

  $("saveOperaBtn").disabled = false;

  utmZona.value = "";
  utmE.value = "";
  utmN.value = "";
  if(marker){ map.removeLayer(marker); marker=null; }

  if(anpCod){
    await genOperaId(anpCod);
  }else{
    operaId.value = "";
  }

  msg("Evento cerrado. Puedes iniciar un nuevo operativo.");
};

/* ================== INIT ================== */
(async ()=>{
  renderInst(); renderComp();
  await cargarANP();
  await cargarInstituciones();
  await cargarComponentes();
  await loadDepartamentos();
})();
</script>
</body>
</html>